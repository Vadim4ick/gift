name: Deploy to VPS

on:
  push:
    branches:
      - main

env:
  APP_DIR: giftjs-app # –ø–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ VPS: /home/${SERVER_USER}/giftjs-app
  NODE_VERSION: 22.14.0 # –º–æ–∂–µ—à—å –ø–æ–º–µ–Ω—è—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

jobs:
  # 1) –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —á—Ç–æ –ø–æ–º–µ–Ω—è–ª–æ—Å—å –≤ —ç—Ç–æ–º –ø—É—à–µ
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      blog_changed: ${{ steps.changed.outputs.blog_changed }}
      other_changed: ${{ steps.changed.outputs.other_changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect blog vs other changes
        id: changed
        run: |
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –º–µ–∂–¥—É –¥–≤—É–º—è –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ –∫–æ–º–º–∏—Ç–∞–º–∏
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          BLOG_CHANGED="false"
          OTHER_CHANGED="false"

          # –ï—Å–ª–∏ –ø–æ–º–µ–Ω—è–ª–æ—Å—å —á—Ç–æ-—Ç–æ –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ –±–ª–æ–≥–∞ –∏–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞—Ö –±–ª–æ–≥–∞
          if echo "$CHANGED_FILES" | grep -E '^src/shared/content/blog/|^public/images/blog/' > /dev/null; then
            BLOG_CHANGED="true"
          fi

          # –ï—Å–ª–∏ –ø–æ–º–µ–Ω—è–ª–æ—Å—å —á—Ç–æ-—Ç–æ –µ—â—ë (–∫–æ–¥, –∫–æ–Ω—Ñ–∏–≥–∏ –∏ —Ç.–ø.)
          if echo "$CHANGED_FILES" | grep -vE '^src/shared/content/blog/|^public/images/blog/' | grep -v '^$' > /dev/null; then
            OTHER_CHANGED="true"
          fi

          echo "blog_changed=$BLOG_CHANGED"  >> $GITHUB_OUTPUT
          echo "other_changed=$OTHER_CHANGED" >> $GITHUB_OUTPUT

  # 2) –ü–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π: –±–∏–ª–¥ Next –Ω–∞ GitHub + –¥–æ—Å—Ç–∞–≤–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –Ω–∞ VPS
  deploy-full:
    needs: detect-changes
    # –ó–∞–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–Ω–µ –±–ª–æ–≥-–∫–æ–Ω—Ç–µ–Ω—Ç–∞
    if: needs.detect-changes.outputs.other_changed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm install

      - name: Build Next.js
        env:
          # –ï—Å–ª–∏ –¥–ª—è –±–∏–ª–¥–∞ –Ω—É–∂–Ω—ã env-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ‚Äî –∑–∞—à–∏–≤–∞–π –∏—Ö –≤ secrets –∏ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–π —Å—é–¥–∞
          NODE_OPTIONS: "--max-old-space-size=2536 --no-deprecation"
        run: npm run build

      # –£–ø–∞–∫–æ–≤—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Ä–∞–Ω—Ç–∞–π–º–∞:
      # .next, public, package.json, package-lock.json (–µ—Å–ª–∏ –µ—Å—Ç—å)
      - name: Prepare artifact
        run: |
          mkdir -p artifact
          cp -r .next artifact/.next
          cp -r public artifact/public
          cp package.json artifact/
          if [ -f package-lock.json ]; then
            cp package-lock.json artifact/
          fi
          # –µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å ecosystem.config.cjs –≤ —Ä–µ–ø–æ, —Ç–æ–∂–µ –ø–æ–ª–æ–∂–∏
          if [ -f ecosystem.config.cjs ]; then
            cp ecosystem.config.cjs artifact/
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: next-build
          path: artifact

      - name: Set up SSH access
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: next-build
          path: artifact

      - name: Deploy & restart via PM2
        run: |
          rsync -az --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            artifact/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.REMOTE_HOST }}:/home/${{ secrets.SERVER_USER }}/${{ env.APP_DIR }}/

          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.REMOTE_HOST }} << 'EOF'
          set -e

          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
          # nvm use 22.14.0   # –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∂—ë—Å—Ç–∫–æ –≤—ã–±—Ä–∞—Ç—å –≤–µ—Ä—Å–∏—é

          cd ~/${APP_DIR}

          echo "üì¶ –ö–æ–ø–∏—Ä—É–µ–º .env"
          cp ~/secrets/giftjs/.env .env

          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (production)"
          npm install --omit=dev

          echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º / –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ PM2"
          if pm2 list | grep -q giftjs-app; then
            pm2 restart giftjs-app --update-env
          else
            pm2 start ecosystem.config.cjs --env production --update-env
          fi

          pm2 save
          EOF

  # 3) –ë—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π: —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–Ω—Ç –±–ª–æ–≥–∞ –∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏
  deploy-blog:
    needs: detect-changes
    if: needs.detect-changes.outputs.blog_changed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH access
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Rsync blog content to VPS
        run: |
          rsync -az \
            -e "ssh -o StrictHostKeyChecking=no" \
            --include='src/' \
            --include='src/shared/' \
            --include='src/shared/content/' \
            --include='src/shared/content/blog/***' \
            --include='public/' \
            --include='public/images/' \
            --include='public/images/blog/***' \
            --exclude='*' \
            ./ \
            ${{ secrets.SERVER_USER }}@${{ secrets.REMOTE_HOST }}:/home/${{ secrets.SERVER_USER }}/${{ env.APP_DIR }}/

      - name: Restart PM2 (pick up new content)
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.REMOTE_HOST }} << 'EOF'
          set -e

          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
          # nvm use 22.14.0

          cd ~/${APP_DIR}

          echo "üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º giftjs-app –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–ª–æ–≥–∞"
          if pm2 list | grep -q giftjs-app; then
            pm2 restart giftjs-app --update-env
            pm2 save
          else
            echo "‚ö†Ô∏è PM2 –ø—Ä–æ—Ü–µ—Å—Å–∞ giftjs-app –Ω–µ—Ç, –Ω–∏—á–µ–≥–æ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º"
          fi
          EOF
